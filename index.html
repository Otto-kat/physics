<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è‡ªç„¶çª¥æ¢è€… Â· Firebase + Supabase + LaTeX + Python</title>

    <!-- ç²’å­èƒŒæ™¯ -->
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

    <!-- CodeMirrorï¼ˆLaTeX & Python ç¼–è¾‘å™¨ï¼‰ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/stex/stex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/dracula.min.css">

    <!-- Pyodideï¼ˆè¿è¡Œ Pythonï¼‰ -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg1: #101522;
            --bg2: #1e293b;
            --card: rgba(255,255,255,0.08);
            --text: #f1f5f9;
            --muted: #94a3b8;
            --accent: #3b82f6;
            --accent-contrast: #fff;
            --radius: 12px;
            --shadow: 0 6px 20px rgba(15,23,40,0.3);
        }

        body {
            font-family: Inter,"Microsoft YaHei",system-ui,Arial;
            background: linear-gradient(160deg,var(--bg1),var(--bg2));
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            max-width: 760px;
            margin: 40px auto;
            backdrop-filter: blur(10px);
        }

        .about {
            text-align: center;
            font-size: 14px;
            color: var(--muted);
            margin-top: 20px;
            line-height: 1.6;
        }

            .about b {
                color: var(--accent);
            }

        h2 {
            font-weight: 700;
            color: #fff;
        }

        .comment {
            border-top: 1px solid rgba(255,255,255,0.15);
            margin-top: 8px;
            padding-top: 8px;
        }

        .file-link {
            color: var(--accent);
            text-decoration: underline;
            font-size: 13px;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

            button:hover {
                background: #2563eb;
                transform: scale(1.03);
            }

        .CodeMirror {
            border-radius: 6px;
            background: rgba(255,255,255,0.08);
            height: 200px;
        }

        #pyOutput {
            background: rgba(0,0,0,0.3);
            padding: 6px;
            border-radius: 6px;
            margin-top: 6px;
            min-height: 40px;
            white-space: pre-wrap;
        }

        .lang-switch {
            float: right;
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="card">
        <div><h2 id="title">è‡ªç„¶çª¥æ¢è€… Â· Firebase + Supabase + LaTeX + Python</h2><span class="lang-switch" id="langToggle">ğŸŒ English</span></div>
        <p class="small" id="desc">ä¸Šä¼  PDF æˆ–å›¾ç‰‡è¯„è®ºï¼Œå…¨ç½‘å¯è§ + å†…ç½® LaTeX & Python ç¼–è¾‘å™¨</p>

        <input id="cName" type="text" placeholder="åå­— (å¿…å¡«)" style="margin-top:6px;width:100%;"><br>
        <input id="cEmail" type="email" placeholder="é‚®ç®± (å¯é€‰)" style="margin-top:6px;width:100%;"><br>

        <textarea id="cText" placeholder="è¯„è®ºå†…å®¹ (æ”¯æŒ Markdown & LaTeX)" style="width:100%;height:100px;margin-top:6px;"></textarea><br>
        <input id="cFile" type="file" accept="application/pdf,image/png,image/jpeg" style="margin-top:6px;"><br>

        <h3 style="margin-top:10px;">ğŸ§® LaTeX ç¼–è¾‘åŒº</h3>
        <textarea id="latexEditor">$$E=mc^2$$</textarea>
        <div id="latexPreview" style="padding:8px;"></div>

        <h3 style="margin-top:10px;">ğŸ Python ç¼–è¾‘åŒº</h3>
        <textarea id="pyEditor">print("Hello, Quantum World!")</textarea>
        <button id="runPython" style="margin-top:6px;">â–¶ è¿è¡Œ Python</button>
        <div id="pyOutput"></div>

        <button id="addComment" style="margin-top:8px;">æäº¤è¯„è®º</button>
        <div id="uploadStatus" class="small" style="margin-top:4px;"></div>
        <div id="storageUsage" class="small" style="margin-top:10px;"></div>
        <div id="commentsContainer" style="margin-top:12px;"></div>

        <div class="about">
            <b>Otto Von Davinstar</b><br>
            â€œIf you want to find the secrets of the universe,<br>
            think in terms of energy, frequency and vibration.â€<br>â€” N. Tesla
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.esm.js";

        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCPDiyZtMUe_RNudnvXmaZGUfwhJjKVXOs",
            authDomain: "my-light-site.firebaseapp.com",
            projectId: "my-light-site",
            storageBucket: "my-light-site.appspot.com",
            messagingSenderId: "870998893975",
            appId: "1:870998893975:web:ce4b1d412168e07b5390d2"
        };
        const db = getFirestore(initializeApp(firebaseConfig));

        // Supabase
        const supabase = createClient("https://isnamqcyzimvlmaiczeu.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzbmFtcWN5emltdmxtYWljemV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTQwODEsImV4cCI6MjA3ODAzMDA4MX0.WcwFDqu-22xMWanw3mWqrIN2M1llNBI-bDrO3QkmlMI");

        // DOM
        const addBtn = document.getElementById("addComment"), commentsContainer = document.getElementById("commentsContainer"),
            statusEl = document.getElementById("uploadStatus"), usageEl = document.getElementById("storageUsage");

        // CodeMirror åˆå§‹åŒ–
        const latexEditor = CodeMirror.fromTextArea(document.getElementById("latexEditor"), { mode: "stex", theme: "dracula", lineNumbers: true });
        const pyEditor = CodeMirror.fromTextArea(document.getElementById("pyEditor"), { mode: "python", theme: "dracula", lineNumbers: true });

        // LaTeX å®æ—¶é¢„è§ˆ
        latexEditor.on("change", () => { document.getElementById("latexPreview").innerHTML = latexEditor.getValue(); MathJax.typesetPromise(["latexPreview"]); });

        // Python è¿è¡Œ
        let pyodide;
        async function initPy() { pyodide = await loadPyodide(); }
        initPy();
        document.getElementById("runPython").onclick = async () => {
            if (!pyodide) return alert("Python ç¯å¢ƒåŠ è½½ä¸­...");
            const code = pyEditor.getValue();
            try {
                const out = await pyodide.runPythonAsync(code);
                document.getElementById("pyOutput").textContent = out ?? "ï¼ˆæ— è¾“å‡ºï¼‰";
            } catch (e) { document.getElementById("pyOutput").textContent = "âš ï¸ " + e; }
        };

        // å­˜å‚¨æ˜¾ç¤ºï¼ˆå¸¦ç¼“å­˜ï¼‰
        async function showStorageUsage() {
            try {
                let cached = localStorage.getItem("storageMB");
                if (cached) usageEl.innerHTML = cached;
                let totalBytes = 0;
                const { data, error } = await supabase.storage.from("p").list("uploads", { limit: 1000 });
                if (error) throw error;
                for (const f of data) if (f.metadata?.size) totalBytes += Number(f.metadata.size);
                const usedMB = (totalBytes / (1024 * 1024)).toFixed(2), totalMB = 1024;
                const remainMB = (totalMB - usedMB).toFixed(2);
                const percent = Math.min(((usedMB / totalMB) * 100).toFixed(1), 100);
                const html = `ğŸ’¾ å½“å‰ä½¿ç”¨ï¼š<b>${usedMB}MB</b> / ${totalMB}MBï¼ˆå‰©ä½™ <b>${remainMB}MB</b>ï¼‰<div style="background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;margin-top:4px;height:8px;"><div style="width:${percent}%;background:#3b82f6;height:8px;"></div></div>`;
                usageEl.innerHTML = html; localStorage.setItem("storageMB", html);
            } catch (e) { usageEl.textContent = "âš ï¸ æ— æ³•è·å–å­˜å‚¨ä¿¡æ¯"; }
        }
        setInterval(showStorageUsage, 30000);

        // åŠ è½½è¯„è®º
        async function renderComments() {
            commentsContainer.innerHTML = "<div class='small'>åŠ è½½ä¸­...</div>";
            const snap = await getDocs(query(collection(db, "comments"), orderBy("ts", "desc")));
            commentsContainer.innerHTML = "";
            snap.forEach(d => {
                const c = d.data(), div = document.createElement("div");
                div.className = "comment";
                div.innerHTML = `<div><b>${c.name}</b> <span class='small'>${c.ts?.toDate ? c.ts.toDate().toLocaleString() : ""}</span></div>
        <div>${marked.parse(c.text || "")}</div>${c.fileUrl ? `<a href='${c.fileUrl}' class='file-link' target='_blank'>ğŸ“ ${c.fileName}</a>` : ""}`;
                commentsContainer.appendChild(div);
                if (window.MathJax) MathJax.typesetPromise([div]);
            });
        }

        // ä¸Šä¼ è¯„è®º
        addBtn.onclick = async () => {
            const name = document.getElementById("cName").value.trim();
            const text = document.getElementById("cText").value.trim() + "\n\n" + latexEditor.getValue() + "\n```python\n" + pyEditor.getValue() + "\n```";
            const file = document.getElementById("cFile").files[0];
            if (!name || !text) return alert("è¯·å¡«å†™åå­—å’Œè¯„è®º");
            statusEl.textContent = "æ­£åœ¨ä¸Šä¼ ...";
            let fileUrl = "", fileName = "";
            if (file) {
                fileName = file.name;
                const filePath = `uploads/${Date.now()}_${encodeURIComponent(file.name)}`;
                const { error } = await supabase.storage.from("p").upload(filePath, file);
                if (!error) { const { data } = supabase.storage.from("p").getPublicUrl(filePath); fileUrl = data.publicUrl; }
            }
            await addDoc(collection(db, "comments"), { name, text, fileUrl, fileName, ts: serverTimestamp() });
            statusEl.textContent = "âœ… å·²å‘å¸ƒ"; renderComments(); showStorageUsage();
        };
        renderComments(); showStorageUsage();
    </script>

    <script>
        particlesJS("particles-js", { particles: { number: { value: 90 }, color: { value: "#60a5fa" }, shape: { type: "circle" }, opacity: { value: 0.5 }, size: { value: 2 }, line_linked: { enable: true, distance: 120, color: "#60a5fa", opacity: 0.3, width: 1 }, move: { enable: true, speed: 1.3, out_mode: "bounce" } }, interactivity: { events: { onhover: { enable: true, mode: "repulse" } }, modes: { repulse: { distance: 100 } } }, retina_detect: true });
    </script>
</body>
</html>
