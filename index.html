<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Firebase + Supabase æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #fff;
            --text: #0f1720;
            --muted: #6b7280;
            --accent: #2563eb;
            --accent-contrast: #fff;
            --radius: 12px;
            --shadow: 0 6px 20px rgba(15,23,40,0.06);
        }

        body {
            font-family: Inter, "Microsoft YaHei", system-ui, Arial;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 16px;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            max-width: 640px;
            margin: 0 auto;
        }

        .comment {
            border-top: 1px solid #e2e8f0;
            margin-top: 8px;
            padding-top: 8px;
        }

        .file-link {
            display: inline-block;
            color: var(--accent);
            text-decoration: underline;
            font-size: 13px;
            margin-top: 4px;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>Firebase + Supabase ä¸Šä¼ ç¤ºä¾‹</h2>
        <p class="small">ä¸Šä¼  PDF/å›¾ç‰‡è¯„è®ºï¼Œå…¨ç½‘å¯è§</p>

        <input id="cName" type="text" placeholder="åå­— (å¿…å¡«)" style="width:100%;margin-top:6px;"><br>
        <input id="cEmail" type="email" placeholder="é‚®ç®± (å¯é€‰)" style="width:100%;margin-top:6px;"><br>
        <textarea id="cText" placeholder="è¯„è®ºå†…å®¹ (å¿…å¡«)" style="width:100%;min-height:80px;margin-top:6px;"></textarea><br>
        <input id="cFile" type="file" accept="application/pdf,image/png,image/jpeg" style="margin-top:6px;"><br>
        <button id="addComment" style="margin-top:8px;">æäº¤è¯„è®º</button>

        <div id="uploadStatus" class="small" style="margin-top:4px;"></div>
        <div id="commentsContainer" style="margin-top:12px;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import {
            getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        // ğŸ”¥ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCPDiyZtMUe_RNudnvXmaZGUfwhJjKVXOs",
            authDomain: "my-light-site.firebaseapp.com",
            projectId: "my-light-site",
            storageBucket: "my-light-site.appspot.com",
            messagingSenderId: "870998893975",
            appId: "1:870998893975:web:ce4b1d412168e07b5390d2",
            measurementId: "G-YEW0X7YB17"
        };

        // âœ… Supabase é…ç½®ï¼ˆä½ æä¾›çš„ URL + anon keyï¼‰
        const supabaseUrl = "https://isnamqcyzimvlmaiczeu.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzbmFtcWN5emltdmxtYWljemV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTQwODEsImV4cCI6MjA3ODAzMDA4MX0.WcwFDqu-22xMWanw3mWqrIN2M1llNBI-bDrO3QkmlMI";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const addBtn = document.getElementById('addComment');
        const commentsContainer = document.getElementById('commentsContainer');
        const statusEl = document.getElementById('uploadStatus');

        async function renderComments() {
            commentsContainer.innerHTML = "<div class='small'>åŠ è½½ä¸­...</div>";
            const q = query(collection(db, "comments"), orderBy("ts", "desc"));
            const snap = await getDocs(q);
            commentsContainer.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                const el = document.createElement('div');
                el.className = "comment";
                el.innerHTML = `
              <div><strong>${c.name || 'è®¿å®¢'}</strong>
              <span class='small'>${c.ts?.toDate ? c.ts.toDate().toLocaleString() : ''}</span></div>
              <div>${c.text || ''}</div>
              ${c.fileUrl ? `<a class="file-link" href="${c.fileUrl}" target="_blank">ğŸ“ ${c.fileName}</a>` : ''}
            `;
                commentsContainer.appendChild(el);
            });
            if (!snap.size) commentsContainer.innerHTML = "<div class='small muted'>æš‚æ— è¯„è®º</div>";
        }

        addBtn.addEventListener('click', async () => {
            const name = document.getElementById('cName').value.trim();
            const email = document.getElementById('cEmail').value.trim();
            const text = document.getElementById('cText').value.trim();
            const fileInput = document.getElementById('cFile');
            if (!name || !text) return alert("è¯·å¡«å†™åå­—å’Œè¯„è®ºå†…å®¹");

            statusEl.textContent = "æ­£åœ¨ä¸Šä¼ ...";
            let fileUrl = "", fileName = "";

            const file = fileInput.files[0];
            if (file) {
                fileName = file.name;

                // âœ… ç”Ÿæˆå®‰å…¨æ–‡ä»¶åï¼šç§»é™¤é ASCIIï¼Œé¿å… header æŠ¥é”™
                const asciiName = file.name.normalize('NFKD').replace(/[^\x00-\x7F]/g, '');
                const safeName = encodeURIComponent(asciiName.replace(/[^\w.\-]/g, '_') || Date.now().toString());
                const filePath = `uploads/${Date.now()}_${safeName}`;

                try {
                    const { data, error } = await supabase.storage
                        .from('p') // âš ï¸ è¯·ç¡®ä¿ bucket åæ˜¯ â€œpâ€
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            contentType: file.type,
                            upsert: false
                        });

                    if (error) throw error;

                    const { data: publicData, error: pubErr } = supabase.storage
                        .from('p')
                        .getPublicUrl(filePath);

                    if (pubErr) throw pubErr;
                    fileUrl = publicData.publicUrl;
                } catch (err) {
                    console.error("Supabase upload error:", err);
                    statusEl.textContent = "ä¸Šä¼ å¤±è´¥ï¼š" + (err.message || String(err));
                    return;
                }
            }

            // âœ… ä¿å­˜è¯„è®ºåˆ° Firestore
            try {
                await addDoc(collection(db, "comments"), {
                    name, email, text, fileUrl, fileName, ts: serverTimestamp()
                });
                statusEl.textContent = "âœ… å·²ä¸Šä¼ å¹¶å‘å¸ƒ";
                fileInput.value = "";
                document.getElementById('cText').value = "";
                renderComments();
            } catch (e) {
                console.error("Firestore save error:", e);
                statusEl.textContent = "ä¿å­˜è¯„è®ºå¤±è´¥ï¼š" + (e.message || e);
            }
        });

        renderComments();
    </script>
</body>
</html>
